<!DOCTYPE HTML>
<html>
<head>
	<meta charset="UTF-8">
	<!--<script src="http://localhost:4000/socket.io/socket.io.js"></script> -->
	<!-- <script type="text/javascript" src="scripts.js"></script> -->

    <title>HTML5 Canvas + Node.JS Socket.io</title>
    <style>
        div#container {
            padding: 10px;
            clear: both;
        }
        canvas {
            margin-top: 20px
        }
        table#hex-keypad {
            background: #CCC;
            margin-top: 20px;
        }
        td#hex-number {
            padding: 10px;
            padding-left: 20px;
            padding-right: 20px;
            font-size: 20px;
            user-select: none;
            -moz-user-select: none;
            -khtml-user-select: none;
            -webkit-user-select: none;
            -o-user-select: none;
        }
        .pressed {
            background: #2ad58a
        }
        div#description {
            margin-left: 20px;
            justify-content: center;
            align-items: center;
        }
        button#stepButton {
            margin-bottom: 20px;
        }
        div.column {
            float: left;
            width: 50%;
        }
        div.innerColumn {
            float: left;
            width: 33%;
            margin-bottom: 15px;
        }
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }
        th, td {
            padding: 5px;
            text-align: center;
        }
        p.bold {
            font-style: italic;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="container">
        <div class="column">
            Chip8 Typescript Emulator
            <select id="gameSelector" onchange="changeGame()">
            </select>
            <article><!-- our canvas will be inserted here--></article>
            <table id="hex-keypad">
                <tr>
                    <td id="hex-number">C</td>
                    <td id="hex-number">D</td>
                    <td id="hex-number">E</td>
                    <td id="hex-number">F</td>
                </tr>
                <tr>
                    <td id="hex-number">8</td>
                    <td id="hex-number">9</td>
                    <td id="hex-number">A</td>
                    <td class="pressed" id="hex-number">B</td>
                </tr>            
                <tr>
                    <td id="hex-number">4</td>
                    <td id="hex-number">5</td>
                    <td id="hex-number">6</td>
                    <td id="hex-number">7</td>
                </tr>
                <tr>
                    <td id="hex-number">0</td>
                    <td id="hex-number">1</td>
                    <td id="hex-number">2</td>
                    <td id="hex-number">3</td>
                </tr>
            </table>
            <div id="description">
                <p id="infoText"></p>
            </div>
            Frames Pr Second: <input type="number" id="fps" value="60">
            <button id="togglePause" onclick="togglePause()">Start</button>
            <br>
            <button onclick="step()" id="stepButton">Step</button>
            <br>
            Memory Start:<input type="number" id="memoryStart" value="200">
            <br>
            Memory End:     <input type="number" id="memoryEnd" value="220">
            <br>
            Debug Log Screen: <input type="checkbox" id="screenDebug">
            <button onclick="debug()">Debug</button>
        </div>
        <div class="column">
            <p>Debug Information</p>
            <br>
            <p class="bold">Registers</p>
            <table>
                <tr id="registerRowHeader">
                    
                </tr>
                <tr id="registerRowData">

                </tr>
            </table>
            <p class="bold">Program Counter</p>
            <p id="programCounter"></p>
            <p class="bold">Current Instruction</p>
            <p id="instruction"></p>
            <p class="bold">Address Register</p>
            <p id="addressRegister"></p>
            <p class="bold">Memory</p>
            <div class="innerColumn">
                <table id="memoryTable1">
                </table>
            </div>
            <div class="innerColumn">
                <table id="memoryTable2">
                </table>
            </div>
            <div class="innerColumn">
                <table  id="memoryTable3">
                </table>
            </div>
            <br>
            <p class="bold stackTitle">Stack</p>
            <p id="stackTable"></p>
        </div>
    </div>
    


	<!-- Scripts required -->
	<!-- <script src="http://localhost:4000/socket.io/socket.io.js"></script> -->
    <!-- <script type="text/javascript" src="scripts.js"></script> -->
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script>
        const socket = io({
            'reconnection': true,
            'reconnectionDelay': 250,
            'reconnectionDelayMax' : 1000,
            'reconnectionAttempts': 120
        });
        const canvas = document.createElement("canvas");

        canvas.width = 640;
        canvas.height = 320;
        const context = canvas.getContext("2d");

        document.querySelectorAll("article")[0].append(canvas);
        // const socket = io.connect("http://localhost:4000");
        socket.on("draw", (data) => {
            // console.log(`Drawing`, data);
            for (let i = 0; i < data.length; i++) {
                for (let j = 0; j < data[i].length; j++) {
                    context.fillStyle = data[i][j] ? "white" : "black";
                    context.fillRect(i * 10, j * 10, 10, 10);
                }
            }
        })

        socket.on("keys", (data) => {
            const hexNumbers = document.querySelectorAll("#hex-number");
            for (let i = 0; i < data.length; i++) {
                if (data[i]) {
                    hexNumbers[i].classList.add("pressed");
                } else {
                    hexNumbers[i].classList.remove("pressed");
                }
            }
        })

        socket.on("registers", (data) => {
            const rowHeader = document.querySelector("#registerRowHeader");
            const rowData = document.querySelector("#registerRowData");
            let headerHTML = "";
            let rowDataHTML = "";
            for (let i = 0; i <= 0xF; i++) {
                headerHTML += `<th>v${i.toString(16).toUpperCase()}</th>`;
                rowDataHTML += `<td>0x${data[i].toString(16).padStart(2, "0").toUpperCase()} (${data[i]})</td>`
            }
            rowHeader.innerHTML = headerHTML;
            rowData.innerHTML = rowDataHTML;
        });

        socket.on("programCounter", (data) => {
            const element = document.querySelector("#programCounter");
            element.innerText = `0x${data.toString(16).padStart(2, "0").toUpperCase()} (${data})`;
        });

        socket.on("instruction", (data) => {
            const element = document.querySelector("#instruction");
            element.innerText = `0x${data.toString(16).padStart(4, "0").toUpperCase()} (${data})`;
        });

        socket.on("addressRegister", (data) => {
            const element = document.querySelector("#addressRegister");
            element.innerText = `0x${data.toString(16).padStart(2, "0").toUpperCase()} (${data})`;
        });

        socket.on("memory", (data) => {
            const split = Math.floor(data.length / 3);
            const startLocation = parseInt(document.querySelector("#memoryStart").value);
            const memoryTable1 = document.querySelector("#memoryTable1");
            const memoryTable2 = document.querySelector("#memoryTable2");
            const memoryTable3 = document.querySelector("#memoryTable3");
            let table1 = "";
            for (let i = 0; i < split; i++) {
                let index = i;
                table1 += `<tr><th>0x${(startLocation + index).toString(16).padStart(2, "0").toUpperCase()} (${startLocation + index})</th><td>${data[index]}</td></tr>`;
            }
            let table2 = "";
            for (let i = split; i < split * 2; i++) {
                let index = i;
                table2 += `<tr><th>0x${(startLocation + index).toString(16).padStart(2, "0").toUpperCase()} (${startLocation + index})</th><td>${data[index]}</td></tr>`;
            }
            let table3 = "";
            for (let i = split * 2; i < data.length; i++) {
                let index = i;
                table3 += `<tr><th>0x${(startLocation + index).toString(16).padStart(2, "0").toUpperCase()} (${startLocation + index})</th><td>${data[index]}</td></tr>`;
            }
            memoryTable1.innerHTML = table1;
            memoryTable2.innerHTML = table2;
            memoryTable3.innerHTML = table3;
        });

        socket.on("stack", (data) => {
            let stackData = "[";
            for (let i = 0; i < data.length; i++) {
                stackData += `0x${data[i].toString(16).padStart(4, "0").toUpperCase()} (${data[i]}), `;
            }
            
            stackData = (stackData.length > 2 ? stackData.slice(0, stackData.length - 2) : stackData) + "]";
            document.querySelector("#stackTable").innerText = stackData;
        });

        socket.on("games", (games) => {
            console.log(`Received games list:`, games);
            let gamesData = "";
            for (let i = 0; i < games.length; i++) {
                gamesData += `<option value="${games[i]}">${games[i]}</option>`;
            }
            console.log(gamesData);
            document.querySelector("#gameSelector").innerHTML = gamesData;
        });

        socket.on("beep", () => {
            beep();
        })

        document.body.onkeydown = (e) => {
            socket.emit("keydown", e.key);
        }

        document.body.onkeyup = (e) => {
            socket.emit("keyup", e.key);
        }

        function step() {
            socket.emit("step");
        }

        function debug() {
            const screenDebug = document.querySelector("#screenDebug");
            const memoryStart = document.querySelector("#memoryStart");
            const memoryEnd = document.querySelector("#memoryEnd");
            socket.emit("debug", [screenDebug.checked, memoryStart.value, memoryEnd.value]);
        }

        function togglePause() {
            const togglePause = document.querySelector("#togglePause");
            const fps = document.querySelector("#fps");
            togglePause.textContent = (togglePause.textContent === "Pause" ? "Start" : "Pause");
            socket.emit("togglePause", fps.value);
        }

        function changeGame() {
            socket.emit("changeGame", document.querySelector("#gameSelector").value);
        }

        function beep() {
            var sound = new Audio("data:audio/wav;base64,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qJrx4KOQjahZxWbcZgztj2c49nKmkId44S71j0c8eV9yDK6uPRzx5X18eDvjvQ6yKo9ZSS6l//8elePK/Lf//IInrOF/FvDoADYAGBMGb7FtErm5MXMlmPAJQVgWta7Zx2go+8xJ0UiCb8LHHdftWyLJE0QIAIsI+UbXu67dZMjmgDGCGl1H+vpF4NSDckSIkk7Vd+sxEhBQMRU8j/12UIRhzSaUdQ+rQU5kGeFxm+hb1oh6pWWmv3uvmReDl0UnvtapVaIzo1jZbf/pD6ElLqSX+rUmOQNpJFa/r+sa4e/pBlAABoAAAAA3CUgShLdGIxsY7AUABPRrgCABdDuQ5GC7DqPQCgbbJUAoRSUj+NIEig0YfyWUho1VBBBA//uQZB4ABZx5zfMakeAAAAmwAAAAF5F3P0w9GtAAACfAAAAAwLhMDmAYWMgVEG1U0FIGCBgXBXAtfMH10000EEEEEECUBYln03TTTdNBDZopopYvrTTdNa325mImNg3TTPV9q3pmY0xoO6bv3r00y+IDGid/9aaaZTGMuj9mpu9Mpio1dXrr5HERTZSmqU36A3CumzN/9Robv/Xx4v9ijkSRSNLQhAWumap82WRSBUqXStV/YcS+XVLnSS+WLDroqArFkMEsAS+eWmrUzrO0oEmE40RlMZ5+ODIkAyKAGUwZ3mVKmcamcJnMW26MRPgUw6j+LkhyHGVGYjSUUKNpuJUQoOIAyDvEyG8S5yfK6dhZc0Tx1KI/gviKL6qvvFs1+bWtaz58uUNnryq6kt5RzOCkPWlVqVX2a/EEBUdU1KrXLf40GoiiFXK///qpoiDXrOgqDR38JB0bw7SoL+ZB9o1RCkQjQ2CBYZKd/+VJxZRRZlqSkKiws0WFxUyCwsKiMy7hUVFhIaCrNQsKkTIsLivwKKigsj8XYlwt/WKi2N4d//uQRCSAAjURNIHpMZBGYiaQPSYyAAABLAAAAAAAACWAAAAApUF/Mg+0aohSIRobBAsMlO//Kk4soosy1JSFRYWaLC4qZBYWFRGZdwqKiwkNBVmoWFSJkWFxX4FFRQWR+LsS4W/rFRb/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////VEFHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAU291bmRib3kuZGUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMjAwNGh0dHA6Ly93d3cuc291bmRib3kuZGUAAAAAAAAAACU=");  
            sound.play();
        }

    </script>
</body>